# 米哈游大冒险 (MiHoYo Adventure) - PRD

**版本**: 1.1
**状态**: 开发中 (In Progress)

---

## 目录

1.  [产品概述](#1-产品概述)
2.  [核心玩法循环](#2-核心玩法循环)
3.  [游戏世界观](#3-游戏世界观)
4.  [数值与经济体系](#4-数值与经济体系)
5.  [NPC 与社交系统](#5-npc-与社交系统)
6.  [交互逻辑管道](#6-交互逻辑管道)
7.  [界面与职场系统](#7-界面与职场系统)
8.  [附录：技术规范](#8-附录技术规范)

---

## 1. 产品概述

本项目是一款基于 LLM 的**职场模拟 RPG**。玩家在模拟的 IM (hoyowave) 界面中，通过自然语言交互与数值策略，体验从 P5 萌新到公司合伙人的职业生涯。

### 1.1 核心体验
*   **沉浸式职场**: 还原真实的互联网大厂工作流，从日报周报到跨部门撕逼。
*   **LLM 驱动**: NPC 并非脚本死板回复，而是基于性格与记忆的动态交互。
*   **多维成长**: 只有代码写得好不够，还需要高情商和政治资本。

### 1.2 技术架构
*   **Frontend**: React + TypeScript + TailwindCSS (仿飞书/Lark 界面)
*   **Backend**: FastAPI (Python) - 状态管理与数值计算
*   **AI Core**: Doubao (Ark) 模型 (内网 API) - 意图解析与双层生成

---

## 2. 核心玩法循环

### 2.1 玩家入职
游戏开始时，玩家需完成入职登记，该选择将决定游戏的**初始难度**与**数值倾向**。

*   **输入姓名**: 决定游戏内称呼。
*   **选择岗位**:
*   *   **产品**: 初始软技能较高、硬技能偏低。核心能力「画饼」（提升士气）。
*   *   **研发**: 初始硬技能较高、软技能偏低。核心能力「爆肝」（推进进度）。
*   *   **运营**: 属性较为均衡，初始金钱较高。核心能力「整活」（降低项目风险）。
*   **选择项目组 (Project)**: 决定初始环境压力（详见 [3.1 项目矩阵](#31-项目矩阵-project-matrix)）。

### 2.2 职级晋升体系

| 职级 | 称谓 | 核心权限 | 晋升条件 |
| :--- | :--- | :--- | :--- |
| **P5** | 萌新 | 执行、学习 | 存活12周，无重大事故 |
| **P6** | 资深 | 甩锅、摸鱼 | 参与 Live 项目，KPI ≥ A |
| **P7** | 专家/TL | PUA、招人 | 主导上线，政治资本 > 20 |
| **P8** | 制作人 | 画饼、立项 | 打造爆款 (Revenue > Target) |
| **P9** | 负责人 (VP) | 战略、背锅 | 推动新业务线，培养出 P8 |
| **P10** | 合伙人 (CXO) | 改变世界 | 决定公司生死，长期持有股份 |

### 2.3 结局体系
游戏无唯一终点，LLM 根据玩家生涯生成个性化结局。

*   **Bad Endings**: 保安护送 (Fired)、过劳倒下 (Health)、平庸之辈 (Mediocre)。
*   **Normal Endings**: 和平离职 (Resignation)、永远的打工人 (Stable)。
*   **Good Endings**: 财富自由 (Rich)、金牌制作人 (Producer)、高管之路 (Executive)。
*   **Hidden Endings**: 独立门户 (Indie)、穿越异世界 (Isekai)。

---

## 3. 游戏世界观

### 3.1 项目矩阵
项目组决定了玩家的日常压力与收益风险。

| 项目名称 | 状态 | 难度 (1-5) | 风险 | 备注 |
| :--- | :--- | :--- | :--- | :--- |
| **IAM (Infra)** | Live | 4 | 15 | 基础设施，稳健但枯燥 |
| **崩坏3** | Live | 2 | 10 | 养老项目，收益稳定 |
| **原神** | Live | 5 | 25 | 核心营收，高压高回报 |
| **星穹铁道** | R&D | 3 | 15 | 上升期项目 |
| **绝区零** | R&D | 4 | 20 | 潮流新贵 |
| **HYG** | R&D | 3 | **30** | 高风险预研项目，可能被砍 |

### 3.2 动态演化
*   **新项目生成**: 每 **2年** (游戏时间) 触发一次 "新预研项目" 事件。
    *   随机生成类型 (Game/App/Infra) 与数值 (难度/风险/预算)。
    *   玩家可申请 **转岗 (Transfer)** 成为开荒成员。
*   **季度局外事件**: 每 **3个月** 触发全服事件 (如 "元宇宙爆发", "版号收紧")，动态修正全局数值 (KPI倍率, 预算等)。

### 3.3 全局事件系统
*   **预设事件池**: 30+ 条全局事件，覆盖健康、公司、项目、生活、运势、职业、元事件等类型。
*   **触发条件**:
    * 基于周数 (`min_week`/`max_week`)、玩家心情/精力区间、当前项目风险等过滤候选事件。
    * 每个自然日按基础概率判定事件，基础概率约 8%，当心情或精力过低、项目风险过高时概率提高。
*   **表现形式**:
    * 事件触发时，`active_global_event` 写入 GameState，前端弹出全屏模态遮罩。
    * 遮罩期间输入框禁用，玩家必须阅读提示并点击「知道了，继续上班」确认后才能继续操作。
*   **关键事件示例**:
    * 健康线：住院观察（直接跳过一个季度）、职业倦怠强制休整（跳过 4 周，恢复精力但损失收入）。
    * 项目线：安全事件应急、离谱联动突袭、Bug 雨来袭等，直接影响项目风险、进度与 Bug 数量。
    * 元事件与梗事件：通宵画 AI 战略大饼、All in 二次元赛道、被迫出道的游戏主播等，用较夸张的方式塑造职场黑色幽默。
*   **数值影响**:
    * 事件统一通过后端函数 `_activate_global_event` 结算，对 `week/money/mood/energy/political_capital` 等关键数值做批量调整。
    * 部分事件会记录为长期事实 (Fact)，影响后续结局生成与职业轨迹。

---

## 4. 数值与经济体系

系统遵循 **三层转化模型**，严禁直接修改结果数值。

### 4.1 数值分层
1.  **元属性**: 先天资质 (作为计算系数)。
    *   悟性、精力上限等。
2.  **能力与状态**: 随时间积累/消耗。
    *   硬技能、软技能、信任度、心情、精力等。
3.  **产出**: 结果数值，用于晋升与消费。
    *   业绩、政治资本、金钱等。

### 4.2 核心公式 (Simulation Logic)

以「工作 (WORK)」行为为例：

| 项目 | 数值/公式 | 说明 |
| :--- | :--- | :--- |
| 消耗 | `Energy -10` | 每次标准工作行为固定消耗精力 |
| KPI 计算 | `KPI Gain = floor(10 * (HardSkill / 50) * LearningRate * MoodModifier)` | 硬技能、悟性、心情共同决定单次产出 |
| MoodModifier | Mood 80 ≈ 0.8 | 心情越好，效率越高；心情过低时效率折损 |
| 限制条件 | `Energy < 10` 无法进行高强度工作 | 精力过低时不允许继续高负载工作 |

### 4.3 交互影响 (Interaction Effects)
*   **Player -> Project**:
*   *   投入「硬技能」 -> 增加项目进度。
*   *   投入「软技能」 -> 提升团队士气，降低项目风险。
*   **Project -> Player**:
    *   项目成功 -> `Bonus` (奖金) + `Promotion` (晋升)。
    *   项目被砍 -> `Trust` 大跌，面临裁员风险。
### 4.4 设备与工位升级 (Equipment & Gear)

> 数据来源：`SHOP_ITEMS` + `_apply_shop_item`

本节为装备机制概览；具体条目与数值请参见 4.7.4.B「米购（Shop）全量条目」。

### 4.5 培训与成长 (Training)

> 数据来源：`ACADEMY_COURSES` + `_apply_academy_course`

本节为培训机制概览；具体课程与数值请参见 4.7.4.C「米忽悠学院（Academy）全量条目」。

### 4.6 金钱循环
*   **收入来源**:
    * 项目里程碑与上线奖金、全局 Lucky 事件（理财小阳春、项目特别激励等）。
*   **支出场景**:
    * 日常消耗（米饭点餐）、设备升级（显卡/显示器/工学椅）、培训课程、健康相关全局事件（住院、倦怠休整等）。
*   **设计目标**:
    * 金钱围绕「体力维持 → 能力提升 → 项目收益 → 再投资」形成闭环经营养成系统。

### 4.7 数值一览表（与当前实现对齐）

#### 4.7.0 操作与数值变化总览

| 操作 | 类型 | 玩家数值变化（核心） | 项目数值变化（核心） | 公式/规则要点 |
| :--- | :--- | :--- | :--- | :--- |
| 聊天：WORK | 意图 | Energy -10×强度；Mood -1/ -2/ -5（随强度）；KPI + | 进度 +（Dev > Product > Ops）；风险降（随职业与技能），强度≥1.3会抵消降风险；士气/信任小幅 + | KPI=10×(硬/50)×悟性×心情系数×强度×装备加成×全局系数；装备加成=1+0.05×GPU+0.03×显示器+0.02×椅子 |
| 聊天：SHOP | 意图 | Money -40×强度；Energy +20×强度；Mood +max(1, 3+Mood/50) | 士气 +≈Mood/2；软技能高降风险(≥70 → -1)，低升风险(≤40 → +1) | 生活消费通用结算（非米购物品） |
| 聊天：REFUSE | 意图 | Energy +4×强度；Mood +2×强度 | 进度 -2×强度×(1+硬/80)；风险 +1.5×强度×(1+(100-软)/100)；士气 -强度 | 休息回血但拖项目 |
| 聊天：LEARN | 意图 | Money -80×强度；Energy -20×强度；Product增软+1，其它增硬+1 | 进度 +≥1；风险显著 -；信任 +（随软/硬与职业） | Product：降风险≈(软/32)×强度，信任≈(软/50)×强度；其它：降风险≈(硬/50)×强度，信任≈(软/60)×强度 |
| 聊天：ATTACK | 意图 | Mood -≈2×强度；PoliticalCapital -≈trust_drop/3 | 信任 -；风险 +；士气 - | trust_drop≈3×强度×soft_mod（软≤40→1.3，软≥70→0.8） |
| 指令：cmd:work_hard | 工作 | 同 WORK×1.5 | 进度大幅 +；强压场景风险可能上扬 | 高强度工作（加班爆肝） |
| 指令：cmd:work_normal | 工作 | 同 WORK×1.0 | 额外进度 +0~(硬/40)；风险 ±0~2（Mood≥70更易降，≤40易升） | 老实干活并视技能/心情调节 |
| 指令：cmd:tech_breakthrough | 工作+成长 | Energy -10 左右；Mood -2；硬技能 +1~2 | 进度 ++（随硬技能）；风险显著 - | 技术突破救火 |
| 指令：cmd:make_ppt | 社交/包装 | Energy -6~10；Mood -1~4；软技能 +1 | 进度 +0~2；信任 +2~4；士气 +0~2 | 包装项目故事赚信任 |
| 指令：cmd:align_meeting | 社交/对齐 | 轻度 Energy -；Mood +1 | 进度 +≥1；风险 -0~2（软≥60放大） | 对齐节奏与期望 |
| 指令：cmd:paid_slack | 摸鱼 | Mood +2~6（低心情上限+2）；Energy +2~5（低精力上限+1） | 进度 -1~3（高技能减轻）；信任 -1~2（政治资本高时减轻） | 高压期回血但伤项目 |
| 指令：cmd:rest | 休息 | 同 REFUSE | 同 REFUSE | 单纯休息 |
| 指令：cmd:msg_boss | 向上管理 | Energy -8；PoliticalCapital + | 目标 Boss Trust + | 累积晋升所需政治资本 |
| 指令：cmd:transfer:ID | 职涯 | 无直接数值变化 | 切换当前项目，影响后续所有数值流向 | 转项目线 |
| 米购（示例） | 商城 | 详见 4.7.4 | 详见 4.7.4 | GPU: 硬+3、GPU等级+1；显示器: Mood+5；椅子: MaxEnergy+10、Energy+10 |
| 米饭（示例） | 餐饮 | 详见 4.7.4 | 详见 4.7.4 | standard: ¥30→Energy+20、Mood+5；midnight: ¥45→Energy+25、Mood-3 |
| 学院（示例） | 课程 | 详见 4.7.4 | 详见 4.7.4 | hard_camp: ¥200+精力40→硬+4，高概率悟性+0.1 |

#### 4.7.1 玩家基础属性与角色初始值

| 维度 | 字段 | Product | Dev | Ops | 说明 |
| :--- | :--- | :--- | :--- | :--- | :--- |
| 资源 | 初始金钱 Money | 5000 | 5000 | 8000 | Ops 起步更富裕 |
| 资源 | 精力上限 MaxEnergy | 100 | 120 | 100 | Dev 更耐肝 |
| 成长 | 硬技能 HardSkill | 30 | 70 | 50 | Dev 偏硬核，Product 偏沟通 |
| 成长 | 软技能 SoftSkill | 70 | 30 | 50 | 影响风险与信任 |
| 成长 | 悟性 LearningRate | 1.1 | 1.0 | 1.0 | 影响 KPI 与技能成长效率 |

#### 4.7.2 聊天意图与数值影响（自然语言）

> 实现入口：`_infer_intent_magnitude` + `_apply_effects`

| 意图 | 典型输入关键词 | 主要玩家数值变化 | 主要项目数值变化 | 备注 |
| :--- | :--- | :--- | :--- | :--- |
| WORK | 加班、爆肝、修 Bug、推进 | Energy -10×mag；Mood -1/-2/-5；KPI 按硬技能×悟性×心情×装备计算 | 进度 +（Dev > PM > Ops）；风险 ±（视职业和强度）；士气 & 信任小幅 + | 核心产出行为 |
| SHOP | 买、吃、喝、外卖、咖啡 | Money -40×mag；Energy +20×mag；Mood +3~ | 所在项目士气 +；根据软技能高低微调风险 -1/ +1 | 泛化的“犒劳自己” |
| REFUSE | 摸鱼、摆烂、躺平 | Energy +4×mag；Mood +2×mag | 进度 -；风险 +；士气 - | 短期回血，长期拖项目 |
| LEARN | 学习、培训、上课、复盘 | Money -80×mag；Energy -20×mag；Product 增软技，其它增硬技 | 小幅提高进度、降低风险、增加信任 | 偏长期成长 |
| ATTACK | 骂、冲突、辱骂词 | Mood -；PoliticalCapital - | StakeholderTrust -；Risk +；Morale - | 容易触发被裁线 |
| SOCIAL/SMALL_TALK | 闲聊、八卦、对齐、汇报 | Mood +1~2；Energy -1~-3 | 以软技能为系数，提升项目信任 | 轻量社交与「向上管理」基础 |

#### 4.7.3 主要指令（cmd）数值概览

> 实现入口：`_handle_command`

| 指令 | 类型 | 玩家数值变化（核心） | 项目/关系数值变化（核心） | 用途定位 |
| :--- | :--- | :--- | :--- | :--- |
| `cmd:work_hard` | 工作 | 视 WORK×1.5；高能量消耗，高 KPI | 进度大幅 +，高压时可能反向推高风险 | 爆肝推进进度 |
| `cmd:work_normal` | 工作 | 视 WORK×1.0 | 进度小幅 +；根据心情微调风险；高 hard_skill 时有额外进度奖励 | 默认「老实干活」 |
| `cmd:tech_breakthrough` | 工作+成长 | Energy -10 左右，Mood -2；HardSkill +1~2 | 进度 ++，风险显著 - | 高风险项目救火技能 |
| `cmd:make_ppt` | 社交/包装 | Energy -6~10；Mood -1~4；SoftSkill +1 | 进度 +0~2；StakeholderTrust +2~4；Morale +0~2 | 包装项目故事，赚信任 |
| `cmd:align_meeting` | 社交/对齐 | 轻度 Energy -；Mood +1 | 进度 +≥1；Risk -0~2（随软技能放大） | 对齐排期与期望 |
| `cmd:paid_slack` | 摸鱼 | Mood +2~6；Energy +2~5 | 进度 -1~3；StakeholderTrust -1~2（政治资本高时减轻） | 高压期回血但伤项目 |
| `cmd:rest` | 休息 | 同 REFUSE | 同 REFUSE | 单纯休息 |
| `cmd:msg_boss` | 向上管理 | Energy -8 | 目标 Boss Trust +；玩家 PoliticalCapital + | 累积晋升所需政治资本 |
| `cmd:transfer:ID` | 职涯 | 无直接数值变化 | 切换当前项目，影响后续所有数值流向 | 转项目线 |
| `cmd:add_subordinate` 等 | 管理 | 调整 NPC mood/trust；玩家无直接硬数值收益 | 项目进度透支下属产出；下属心情过低时信任下降 | P7+ 的管理玩法核心 |

#### 4.7.4 消费与成长系统（米饭 / 米购 / 米忽悠学院）

> 实现入口：`_apply_rice_item`、`_apply_shop_item`、`_apply_academy_course`

| 系统 | 代表条目 | 资源消耗 | 玩家收益 | 附加机制 |
| :--- | :--- | :--- | :--- | :--- |
| 米饭 (Rice) | 普通套餐 `standard` | ¥30 | Energy +20，Mood +5 | 用于日常续命 |
|  | 豪华犒劳 `luxury` | ¥80 | Energy +30，Mood +15 | 中概率提升悟性倍率 |
|  | 深夜加班餐 `midnight` | ¥45 | Energy +25，Mood -3 | 适合高压加班，心情受损 |
|  | 脑力自助餐 `brain_buffet` | ¥120 | Energy +28，Mood +18 | 必定提升悟性倍率，P6 解锁，限购 |
| 米购 (Shop) | 限量手办 `gift` | ¥200 | 向同项目/高管送礼：目标 NPC Trust +5~15 | 高管场景下额外提升 PoliticalCapital |
|  | 显卡升级 `gpu` | ¥3000 | HardSkill +3，显卡等级 +1 | 提升 WORK 类 KPI 产出 |
|  | 显示器 `monitor` | ¥2000 | Mood +5，显示器等级 +1 | 长期缓解心情下滑 |
|  | 工学椅 `chair` | ¥1500 | MaxEnergy +10，Energy +10，椅子等级 +1 | 提升长期工作续航 |
|  | AI 工具包 `ai_toolkit` | ¥980 | HardSkill +1，SoftSkill +1，高概率悟性 +0.15 | P6 解锁，限购 |
| 学院 (Academy) | 基础进阶课 `base` | ¥100 + 30 Energy | 定向 Hard/SoftSkill +1；中概率悟性 +0.05 | 日常稳定成长 |
|  | 硬核训练营 `hard_camp` | ¥200 + 40 Energy | HardSkill +4，高概率悟性 +0.1 | 针对硬核技术线 |
|  | 沟通工作坊 `soft_workshop` | ¥200 + 30 Energy | SoftSkill +4，高概率悟性 +0.1 | 针对沟通管理线 |
|  | 领导力 `leadership` | ¥300 + 35 Energy | SoftSkill +2，中概率悟性 +0.1 | 高职级管理型成长，P6 解锁 |

##### 4.7.4.A 米饭（Rice）全量条目

| ID | 名称 | 解锁 | 限购 | 价格 | 精力 | 心情 | 悟性加成 |
| :--- | :--- | :--- | :--- | :--- | :--- | :--- | :--- |
| light | 速食简餐 | P5 | - | ¥15 | +10 | +2 | +0.05 (10%) |
| standard | 普通套餐 | P5 | - | ¥30 | +20 | +5 | +0.05 (15%) |
| luxury | 豪华犒劳 | P5 | - | ¥80 | +30 | +15 | +0.1 (30%) |
| midnight | 深夜加班餐 | P5 | - | ¥45 | +25 | -3 | +0.05 (25%) |
| healthy | 健身餐 | P5 | - | ¥55 | +18 | +6 | +0.05 (25%) |
| salad | 减脂沙拉 | P5 | - | ¥40 | +8 | +4 | +0.05 (20%) |
| spicy | 超辣冒菜 | P5 | - | ¥38 | +18 | +8 | +0.05 (15%) |
| buffet | 自助餐券 | P6 | - | ¥98 | +35 | +18 | +0.1 (40%) |
| afternoon_tea | 下午茶点心 | P5 | - | ¥28 | +6 | +10 | +0.05 (15%) |
| breakfast_combo | 早餐大礼包 | P5 | - | ¥25 | +15 | +5 | +0.05 (20%) |
| late_snack | 夜宵炸鸡 | P5 | - | ¥42 | +16 | +12 | +0.05 (10%) |
| team_lunch | 项目组团建午餐 | P5 | 3 | ¥65 | +20 | +15 | +0.05 (30%) |
| hidden_menu | 食堂隐藏菜单 | P5 | 2 | ¥32 | +22 | +8 | +0.1 (25%) |
| fruit_plate | 办公室水果拼盘 | P5 | - | ¥30 | +8 | +10 | +0.05 (20%) |
| brain_soup | 养生鸡汤 | P5 | - | ¥36 | +18 | +8 | +0.1 (35%) |
| congee | 养胃小米粥 | P5 | - | ¥18 | +12 | +6 | +0.05 (20%) |
| ramen | 深夜拉面 | P5 | - | ¥35 | +18 | +9 | +0.05 (25%) |
| bento | 自带便当 | P5 | - | ¥0 | +14 | +7 | +0.05 (30%) |
| mystery_meal | 神秘今日特餐 | P5 | - | ¥33 | +16 | +6 | +0.15 (30%) |
| brain_buffet | 脑力自助餐 | P6 | 2 | ¥120 | +28 | +18 | +0.2 (100%) |
| cheap_snack | 办公零食凑合吃 | P5 | - | ¥10 | +6 | +3 | +0.05 (10%) |

##### 4.7.4.B 米购（Shop）全量条目

| ID | 名称 | 解锁 | 限购 | 价格 | 精力 | 心情 | 硬技能 | 软技能 | 政治资本 | 悟性加成 |
| :--- | :--- | :--- | :--- | :--- | :--- | :--- | :--- | :--- | :--- | :--- |
| gift | 限量手办礼物 | P5 | 5 | ¥200 | - | - | - | - | +（送高管时加成） | - |
| gpu | 显卡升级 | P5 | - | ¥3000 | - | - | +3 | - | - | - |
| monitor | 显示器升级 | P5 | - | ¥2000 | - | +5 | - | - | - | - |
| chair | 工学椅升级 | P5 | - | ¥1500 | +10 | - | - | - | - | - |
| coffee_pass | 咖啡月卡 | P5 | 2 | ¥260 | - | - | - | - | - | +0.05 (50%) |
| snack_box | 零食补给箱 | P5 | - | ¥120 | - | +10 | - | - | - | - |
| massage_coupon | 按摩理疗券 | P5 | - | ¥180 | +20 | +8 | - | - | - | - |
| noise_headphone | 降噪耳机 | P5 | - | ¥2200 | - | - | - | - | - | +0.1 (80%) |
| standing_desk | 升降桌 | P6 | - | ¥2800 | +10 | +6 | - | - | - | +0.05 (40%) |
| plant | 工位绿植 | P5 | - | ¥60 | - | +6 | - | - | - | - |
| keyboard | 机械键盘 | P5 | - | ¥700 | - | +5 | - | - | - | - |
| mouse | 人体工学鼠标 | P5 | - | ¥350 | +5 | - | - | - | - | - |
| desk_lamp | 护眼台灯 | P5 | - | ¥280 | - | - | - | - | - | +0.05 (40%) |
| book_pack_hard | 硬核技术书单 | P5 | - | ¥400 | - | - | +2 | - | - | +0.1 (70%) |
| book_pack_soft | 管理沟通书单 | P5 | - | ¥380 | - | - | - | +2 | - | +0.1 (70%) |
| cloud_subscription | 云服务订阅 | P5 | - | ¥520 | - | - | +1 | - | - | - |
| ai_toolkit | AI 助手工具包 | P6 | 1 | ¥980 | - | - | +1 | +1 | - | +0.15 (100%) |
| team_snack | 团队下午茶 | P5 | 3 | ¥260 | - | +15 | - | - | +2 | - |
| lucky_draw | 盲盒福袋 | P5 | - | ¥66 | - | +10 | - | - | - | +0.2 (30%) |
| vip_gym | 健身房年卡 | P6 | - | ¥1800 | +10 | - | - | - | - | +0.1 (60%) |

##### 4.7.4.C 米忽悠学院（Academy）全量条目

| ID | 名称 | 解锁 | 限购 | 价格 | 精力消耗 | 硬技能 | 软技能 | 悟性加成 |
| :--- | :--- | :--- | :--- | :--- | :--- | :--- | :--- | :--- |
| base | 基础进阶课 | P5 | - | ¥100 | 30 | +0 | +0 | +0.05 (60%) |
| hard_camp | 硬核技术训练营 | P5 | - | ¥200 | 40 | +4 | +0 | +0.1 (80%) |
| soft_workshop | 沟通协作工作坊 | P5 | - | ¥200 | 30 | +0 | +4 | +0.1 (80%) |
| leadership | 项目管理与领导力 | P6 | - | ¥300 | 35 | +0 | +2 | +0.1 (70%) |
| architecture | 系统架构设计实战 | P6 | - | ¥280 | 35 | +3 | +1 | +0.15 (80%) |
| performance | 性能优化与压测 | P5 | - | ¥260 | 35 | +3 | +0 | +0.1 (70%) |
| product_sense | 产品感与体验设计 | P5 | - | ¥220 | 30 | +0 | +3 | +0.1 (70%) |
| data_analysis | 数据分析与指标体系 | P5 | - | ¥240 | 30 | +2 | +1 | +0.1 (70%) |
| negotiation | 跨部门协同与谈判 | P6 | - | ¥260 | 35 | +0 | +3 | +0.1 (70%) |
| review_skill | 复盘与总结能力 | P5 | - | ¥180 | 25 | +1 | +2 | +0.1 (80%) |

#### 4.7.5 晋升与结局关键阈值（数值侧）

> 实现入口：`_check_promotion`、`_check_game_over`

| 类型 | 条件 | 说明 |
| :--- | :--- | :--- |
| 晋升 P6 | 周数 ≥12；KPI ≥400；无重大事故；参与过至少 1 个 Live 项目或当前在 RD 项目 | 试用期通过，晋升为资深 |
| 晋升 P7 | 周数 ≥24；KPI ≥1300；PoliticalCapital ≥8 | 解锁下属管理与更多指挥权 |
| 晋升 P8 | 周数 ≥36；KPI ≥3000；PoliticalCapital ≥25；总营收 ≥20,000；重大事故 ≤1 | 进入小负责人/制作人候选 |
| 晋升 P9 | 周数 ≥52；KPI ≥5000；PoliticalCapital ≥40；总营收 ≥50,000 | 部门关键角色 |
| 晋升 P10 | 周数 ≥80；PoliticalCapital ≥80；总营收 ≥200,000 | 合伙人级别 |
| Bad Ending：Exhausted | Energy ≤0 | 过劳倒下 |
| Bad Ending：Bankrupt | Money <0 | 资金链断裂 |
| Bad Ending：Depressed/Breakdown | Mood ≤0 或 Mood 极低且 Energy 低，有概率崩溃 | 长期精神状态失衡 |
| Bad Ending：Fired/Pip | 任意高管 Trust ≤0 / 直属上级 Trust ≤0 | 社交作死或长期表现拉胯 |
| 项目失败：ProjectCollapse | 当前项目 Risk ≥95 且 Morale ≤10 | 项目崩盘，玩家被迫背锅 |
| 项目失败：ProjectCancelled | 当前项目 StakeholderTrust ≤0 | 资方彻底失去信任，项目解散 |
| Good Ending：Executive | Week ≥52，KPI ≥5000，PoliticalCapital ≥30 | 晋升为高管 |
| Good Ending：Rich | Week ≥52，Money ≥60,000 | 财富自由 |
| Good Ending：Producer | Week ≥52，总营收 ≥100,000 且 KPI ≥3500 | 成为金牌制作人 |
| Normal Ending：Stable | Week ≥52，未满足其它好结局条件 | 稳定度过一年，成为靠谱中坚 |

#### 4.7.6 周薪与生活成本（经济循环）

| 职级 | 基础周薪 | 生活成本 | 周净收入 | 公式 |
| :--- | :--- | :--- | :--- | :--- |
| P5 | ¥500 | ¥300 | ¥200 | salary = 500 + (level-5)*200；net = salary - 300 |
| P6 | ¥700 | ¥300 | ¥400 | 同上 |
| P7 | ¥900 | ¥300 | ¥600 | 同上 |
| P8 | ¥1100 | ¥300 | ¥800 | 同上 |
| P9 | ¥1300 | ¥300 | ¥1000 | 同上 |
| P10 | ¥1500 | ¥300 | ¥1200 | 同上 |


---


### 5.1 NPC 分类
*   **预定义 NPC**: 由策划维护的核心人物，存放于配置表（如 `backend/backend/data/npcs.json`），不少于 100 位，有固定人设与基础数值。
*   **随机 NPC**: 通过脚本批量生成的路人同事，用于填充各项目组的日常氛围。

每个 NPC 至少包含以下字段：

*   **项目组**：如 IAM、崩坏3、原神、星穹铁道、绝区零、HR、General 等。
*   **职级**：P4–P10，用于判断管理链与是否可被玩家管理。
*   **性格/人设**：若干中文标签或短句，作为大模型生成台词与事件时的提示。
*   **状态**：在职 / 已离职 等，用于生态系统判断。
*   **管理链字段**：  
    * `manager_id`：指向该 NPC 的直属上级 NPC（如 IAM 项目负责人）。  
    * `relations`：记录与其他 NPC 的关系标签（对立、合作、上级、下属等），用于驱动项目生态事件。

### 5.2 核心人物图鉴
| 姓名 | 角色/职位 | 性格标签 | 备注 |
| :--- | :--- | :--- | :--- |
| **Cai (蔡总)** | CTO | 技术宅神、严厉 | 关注底层技术 |
| **Dawei (大伟哥)** | 总裁 | 亲民、用户视角 | 关注玩家体验 |
| **Luo (罗总)** | 联合创始人 | 低调、务实 | 关注商业化/安全 |
| **Shao (烧鸡)** | 编剧 | 文青、刀子手 | 崩坏系列主笔 |
| **Chep** | 美术总监 | 强迫症、唯美 | 画面细节控 |
| **Z** | 音乐总监 | 随性、灵感 | HOYO-MiX 主理人 |
| **CiCi** | HRBP Head | 知性、关怀 | 员工心理健康 |
| **Aquila** | Infra Head | 稳重、可靠 | 服务器守护者 |
| **Fish** | 市场 Head | 活跃、整活 | 社区舆论操盘 |
| **AI-Chan** | 系统/看板娘 | 打破第四面墙 | 新手引导 |

除以上内置核心 NPC 外，预设配置表中还会提供部分米哈游相关 IP 形象（如派蒙、琪亚娜等）在公司世界观中的「拟人化同事版本」，用于增强气氛与彩蛋感。

### 5.3 上下文与记忆 (Context & Memory)
*   **上下文隔离 (Isolation)**:
    *   **私聊 (DM)**: 独立 Context，不与群聊混淆。
    *   **群聊 (Group)**: 支持 `@NPC` 触发特定回复。
*   **记忆持久化**:
    *   **Short-term**: 最近 N 轮对话 (Token Window)。
    *   **Long-term**: 关键事实 (Fact) 与摘要 (Summary) 存入 Vector DB。

---

## 6. 交互逻辑管道

### 6.1 模糊意图量化 (Intent Quantization)
系统将自然语言映射为数值操作。

*   **"稍微加个班"**: `Light Overtime` -> Energy -15, KPI * 1.1.
*   **"通宵肝出来"**: 通宵加班 -> Energy -50, KPI * 1.5，健康风险上升。
*   **"我不干了"**: `Refuse` -> Energy +10, Trust -10.

### 6.2 处理流程 (Pipeline Steps)
1.  **Input**: 用户输入文本。
2.  **Analyzer (LLM Layer 1)**: 分析意图，输出 JSON (Intent, Difficulty)。
3.  **Calculator (Backend)**: 执行数值计算 (Python)，更新 State。
4.  **Generator (LLM Layer 2)**: 生成 NPC 回复与系统旁白。  
    * 输入中会显式包含目标 NPC 的项目组、职级、性格等信息，使同一条玩家发言在面对不同 NPC 时产生差异化回复（例如项目负责人偏向排期和风险，HR 偏向氛围和健康）。

### 6.3 职级与下属玩法

*   **玩家职级**：  
    * 初始为 P5，根据 KPI、政治资本、项目营收等指标在每周结算时判断是否晋升。  
    * 规则示例：P6 需要一定周数 + KPI ≥ 500；P7 需要更高 KPI 与政治资本；更高职级还需全局营收达到阈值。
*   **P7 管理权限解锁**：  
    * 当玩家达到 P7 及以上，可通过指令管理下属：  
        * `cmd:add_subordinate:NPC_ID` — 将同项目组、低职级且在职的 NPC 加入自己的下属列表。  
        * `cmd:remove_subordinate:NPC_ID` — 解除与该 NPC 的一对一汇报关系。  
    * 下属信息会记录在游戏状态中（如 `player_subordinates` 与 NPC 的 `manager_id` 字段）。
*   **指派下属工作**：  
    * 单个指派：`cmd:sub_work:NPC_ID`，由指定下属帮忙推进当前项目进度。  
        * 效果：项目进度小幅提升；下属心情下降，过低时会导致信任度下降。  
    * 集体指派：`cmd:sub_all_work`，发动所有在职下属集体推进项目。  
        * 效果：项目进度显著提升；若有下属心情跌破阈值，会在旁白中提示「对高强度压榨颇有怨言」，并下调其信任度。
*   **设计目标**：  
    * 形成「晋升 → 获得管理权 → 通过下属放大产出 → 但需承担人心与士气代价」的轻量管理玩法。

### 6.3.1 项目负责人与玩家直属上级

*   **项目负责人**：  
    * 每个项目组至少有一名负责人 NPC（通常为 P7+ 或在配置中标注「负责人」），负责在玩法与叙事上代表该项目组。  
    * 项目负责人可以是更高层级（如 P9/P10）的 owner，并不等同于所有员工的直属上级，更偏向业务线总负责人角色。
*   **玩家直属上级**：  
    * 在 `init_game` 时，系统会优先在玩家所属项目组中查找比玩家高 1–2 级的中层 NPC（如 P6/P7）作为直属上级，并记录在玩家状态中（如 `leader_id` 字段）。  
    * 若同项目组中不存在合适的中层 NPC，则退回使用项目负责人作为临时直属上级。  
    * 玩家在入职时收到的首条项目相关欢迎/分工信息，由该直属上级在群聊中发起（可由 LLM 根据其性格与项目情况生成更自然的欢迎与任务分配文案）。  
*   **设计目标**：  
    * 保证每个项目都有一个明确的「说话人」，让玩家在入职瞬间就能感知到具体上级的风格与项目氛围，同时为后续管理链、考核与生态事件提供基础。

### 6.3.2 晋升评估周期与条件（对齐当前实现）

*   **评估节奏**：  
    * 从第 12 周开始，在每周结算时调用晋升检查逻辑。  
    * 满足晋升条件时立即晋升并输出「[晋升] 恭喜！你晋升为 Px」旁白，无须等待季度末。  
    * 若未满足下一档职级条件，则仅在「评估周」（约每 12 周一次）输出「[晋升评估] 本周期暂未晋升」提示与改进建议。
*   **核心指标来源**：  
    * KPI：主要由「工作 (WORK)」类行为产出，受硬技能、悟性倍率与心情影响（参见 4.2、4.3）。  
    * 政治资本 (Political Capital)：通过与高层 NPC 建立信任、管理下属、关键项目表现及部分课程/事件获得。  
    * 项目营收总和 (Revenue Total)：所有项目营收之和，由项目里程碑结算与 Live 周度营收累积（参见 3.3、4.3）。  
    * 重大事故数 (Major Accidents)：当当前项目风险高企（如 Risk ≥ 90）时增加，用于惩罚长期高风险运营。  
    * 参与 Live 项目数 (Participated Live Projects)：玩家在至少一个 Live 项目上持续输出时自动记录，用于避免只在预研项目「纸面优秀」。
*   **当前职级门槛（硬规则）**：  
    * P5 → P6（试用期通过）：  
        * 第 12 周及以后；  
        * 累计 KPI ≥ 500；  
        * 至少参与 1 个已上线项目；  
        * 期间无重大事故记录。  
    * P6 → P7（成为项目骨干）：  
        * 第 24 周及以后；  
        * 累计 KPI ≥ 1500；  
        * 政治资本 ≥ 10。  
    * P7 → P8（领域小负责人）：  
        * 第 36 周及以后；  
        * 累计 KPI ≥ 3000；  
        * 政治资本 ≥ 25；  
        * 项目总营收 ≥ 20,000；  
        * 重大事故次数不超过 1 次。  
    * P8 → P9（部门关键角色）：  
        * 第 52 周及以后；  
        * 累计 KPI ≥ 5000；  
        * 政治资本 ≥ 40；  
        * 项目总营收 ≥ 50,000。  
    * P9 → P10（顶级专家/管理）：  
        * 第 80 周及以后；  
        * 政治资本 ≥ 80；  
        * 项目总营收 ≥ 200,000。  
*   **评估失败反馈**：  
    * 在评估周若未晋升，系统会根据玩家当前职级与数值缺口生成结构化建议，例如：  
        * P5 阶段：提示「至少参与一个已上线项目」「避免重大事故」「累计更多有效 KPI」。  
        * P6 阶段：提示「提升项目 KPI 贡献」「多与关键老板正向互动积累政治资本」。  
        * P7+ 阶段：提示「推动至少一个项目形成可观营收」「在跨团队协作中建立话语权」「降低重大事故次数」等。  
    * 建议以「[晋升评估] 本周期暂未晋升。下一档目标：Px。建议：……」的系统旁白形式出现在群聊中，用于引导玩家理解数值目标与下一步行动。

### 6.4 NPC 生态逻辑

*   **触发时机**：  
    * 以「周」为单位进行结算时，除项目风险等检查外，同时对玩家「已知 NPC」和玩家下属 NPC 执行生态检查。  
    * 仅对玩家有感知的 NPC 进行生态演化，避免对完全路人 NPC 进行无意义的大模型调用。
*   **影响因子**：  
    * Heart 数值：NPC 的心情与信任度越低，越容易触发负向变动。  
    * 项目组：高压项目线的 NPC 更容易申请转岗或离职。  
    * 职级：高职级 NPC 更倾向晋升或跨项目调配。
*   **可能事件**：  
    * **离职**：NPC 状态变为「已离职」，若为玩家下属则自动从下属列表移除，同时小幅降低玩家心情。  
    * **转岗**：NPC 项目从当前项目迁移到其他项目；若与玩家不再同项目且是下属，则解除下属关系。  
    * **晋升**：NPC 职级提升（如从 P5 到 P6），同时略微提升其信任度。  
*   **表现形式**：  
    * 系统在群聊中以旁白形式输出类似「[人事变动] XXX 申请内部转岗，调往 YYY 项目组」的文案。  
    * 未来可将事件生成文本交由大模型根据 NPC 性格、项目压力等自动润色。
*   **预设生态关系**：  
*   * NPC 模型中支持 `relations` 字段，用于记录与其他 NPC 的关系标签（如「对立」「合作」「上级」「下属」等）。  
*   * 典型案例：IAM 项目组中，P7 研发程屿与 P6 产品唐蔷互相标记为「对立」，在周度结算时更容易触发针锋相对的项目生态事件。  
*   **关系驱动事件**：  
    * 周度生态结算时，若玩家已知 NPC 与其关系人同属某项目且均在职，则以一定概率触发「项目生态」旁白：  
        * 「对立」关系更容易生成吵架、争论类事件，双方心情下降，若发生在玩家当前项目组，还会轻微拖累玩家心情。  
        * 「合作」或「搭档」关系更容易生成互相补位、配合默契类事件，提升双方心情，并在同项目情况下轻微提升玩家心情。  
*   **动态生态生成**：  
*   * 对无预设 `relations` 的扩展 NPC，按项目组进行分组，在每一局新游戏初始化时随机生成若干「合作」或「对立」关系对。  
*   * 关系生成会综合职级、岗位与性格标签：例如同项目且性格偏强硬的研发/产品组合，更倾向被标记为「对立」，高职级 NPC 更容易与同项目下级形成上下级或评价型关系。  
    * 这些关系仅存在于当前存档内，不会写回静态配置表，使每一局游戏中的 NPC 生态略有差异。

### 6.5 群聊内 NPC 之间的交互

*   **基础逻辑**：  
    * 当玩家在群聊中发言时，首先按原有流程选择 1–3 名 NPC 对玩家进行回复（基于项目组、性格等）。  
    * 在此基础上，以一定概率额外触发「NPC 互相插嘴」的对话片段，形成吵架、附和等多方互动效果。
*   **触发规则示例**：  
    * 优先选择与玩家当前项目相关或全局项目（General）的 NPC 作为互相插嘴对象。  
    * 高职级 NPC 更可能发起点评，下级 NPC 更可能在后面附和或补充。  
*   **表现形式**：  
    * 追加 1–2 条 NPC 发言，例如「项目负责人吐槽需求风险」「执行同学强调排期现实情况」等，使整个群聊更接近真实职场群氛围。

### 6.6 动态快捷回复 (LLM Suggested Replies)
*   **生成逻辑**:
    * 每次完成一次聊天或指令结算后，后端根据最近约 8 条 `chat_history` 调用 LLM 生成 2 条候选回复，存入 `state.suggested_replies`。
    * 生成规则：强依赖最近一轮玩家发言与 NPC 反馈，长度控制在 10 个汉字以内。
*   **前端表现**:
    * 在输入框上方渲染一排可点击 Chip，优先展示动态 LLM 建议，其次为固定预设快捷语（如「爆肝干活」「摸鱼一会」等）。
    * 玩家点击后会将建议文案写入输入框，可二次修改后通过 Enter 发送。
*   **设计目的**:
    * 强化「上下文相关选项」体验，例如日报被吐槽时给出「进一步优化日报」等自然后续句子。
    * 降低长对话中的输入成本，保持行为仍然由玩家最终确认。

### 6.7 基于玩家输入内容触发相关 NPC

*   **关键词解析**：  
    * 系统会对玩家在群聊中的自然语言进行简单关键词解析，例如「邀请制」「可见性」「IAM」等。  
    * 当检测到这些关键词时，会在 NPC 配置中查找在职且与关键词高度相关的 NPC（例如 trait 中包含「负责 IAM 邀请制和可见性项目」的角色）。  
*   **触发规则**：  
    * 若未明确 @ 某个 NPC，但根据玩家输入匹配到了相关 NPC，则该 NPC 会被视为当前对话的目标对象：  
        * 在本局存档中被标记为「已认识」的 NPC。  
        * 在后续 LLM 回复阶段优先作为发言人参与对话。  
    * 匹配不到合适 NPC 时，不做额外触发，保持原有逻辑。  
*   **设计目的**：  
    * 让「玩家提到某个主题 → 负责这个领域的 NPC 出现并回应」形成自然的因果关系，例如玩家频繁讨论 IAM 邀请制时，对应负责该项目的 NPC 会主动加入群聊或发表看法。  

### 6.8 文本情绪影响 NPC 数值

*   **情绪解析**：  
    * 系统会对玩家输入的自然语言做简单情绪分析，将其粗分为「正面」「负面」「中性」三类。  
    * 情绪分析基于预设的中文情绪关键词列表，例如「好」「棒」「优秀」「厉害」「赞」「满意」「支持」「认可」等视为正向词；「差」「烂」「垃圾」「糟糕」「不满意」「反对」「吐槽」「批评」等视为负向词。  
    * 在一次发言中，统计正向与负向关键词出现次数，用于估算情绪方向与强度。  
*   **数值调整规则**：  
    * 当该轮对话中存在明确的目标 NPC（例如玩家正在与某个 NPC 私聊，或根据 [6.7](#67-基于玩家输入内容触发相关-npc) 解析出了与当前话题最相关的 NPC）且情绪不为中性时，会对该 NPC 的信任度与心情进行数值调整。  
    * 情绪强度会被压缩到固定区间，并映射为 1–5 点的整数变化值：  
        * 正面情绪：`Trust +Δ`，`Mood +Δ`。  
        * 负面情绪：`Trust -Δ`，`Mood -Δ`。  
        * 中性情绪：不做调整。  
    * 调整后会对数值做 0–100 的边界钳制，防止出现负数或超过上限。  
*   **表现形式**：  
    * 数值变化会以系统旁白的形式提示，例如「程屿 因你的正面评价，信任度和心情提升了 3」或「唐蔷 因你的负面评价，信任度和心情下降了 2」。  
    * 该旁白作为事实 (Fact) 写入游戏状态，为后续结算与结局生成提供依据。  
*   **设计目的**：  
    * 让玩家的具体措辞真正影响职场关系，而不仅是触发指令结果：当玩家在群里夸赞某位同事的付出时，对方会对玩家更加信任、心情更好；反之若经常在群内公开吐槽或批评某人，则更容易导致对方对玩家产生负面观感，在后续评审、合作与生态事件中体现出来。  

---

## 7. 界面与职场系统

界面严格参考 **Lark/飞书** 桌面端设计，强调效率与沉浸感。

### 7.1 布局结构
*   **App Bar (最左侧)**: 核心入口。
    *   消息 (Messages)
    *   工作台 (Workbench)
*   **Nav Bar (次左侧)**: 群聊/私聊选择。
*   **Content Area (中间)**: 聊天窗口 / 应用主界面。
*   **Info Panel (右上角)**: 个人中心，悬停后展示3层数值。
### 7.2 应用工作台 (App Workbench)
集成在左侧 App Bar，作为「经营养成」入口，围绕金钱与能力成长设计 3 大模块。

1.  **米饭** — 日常维持  
    * 入口：工作台卡片 + 「点外卖」按钮，可选择不同档位的干饭方式：  
        * `cmd:eat_mifan_light`：速食简餐，消耗 ¥15，精力 +10，心情 +2。  
        * `cmd:eat_mifan`：普通套餐，消耗 ¥30，精力 +20，心情 +5。  
        * `cmd:eat_mifan_luxury`：豪华套餐，消耗 ¥80，精力 +30，心情 +15。  
    * 设计目标：让「时间不够只能快速吃点」「发工资犒劳自己一顿」这类真实场景在数值上有所体现。
2.  **米购** — 固定资产与礼物  
    * 礼物：`cmd:buy_gift`，消耗 ¥200，为随机或当前对话 NPC 提升信任度，若对象为高层可额外增加政治资本。  
    * 固定资产升级：  
        * 显卡 (`cmd:buy_gpu`)：提升硬技能与 GPU 等级。  
        * 显示器 (`cmd:buy_monitor`)：提升 Mood 与显示器等级。  
        * 工学椅 (`cmd:buy_chair`)：提升 MaxEnergy 与当前 Energy，并提升椅子等级。
3.  **米忽悠学院** — 课程与培养  
    * 基础进阶课 (`cmd:learn_skill`)：低成本、根据岗位定向提升当前主修能力。  
    * 硬核技术训练营 (`cmd:train_hard`)：强化硬技能。  
    * 沟通协作工作坊 (`cmd:train_soft`)：强化软技能。  
    * 项目管理与领导力 (`cmd:train_leadership`)：同时提升软技能与政治资本，为晋升做准备。

### 7.3 输入区与事件表现 (Input & Events)
*   **输入控件**:
    * 使用多行文本框，支持 Shift+Enter 换行，单独 Enter 发送消息。
    * 当 `game_over` 或存在 `active_global_event` 时输入框禁用，提示文案引导玩家阅读结局或全局事件。
*   **快捷回复区域**:
    * 位于输入框上方的 Chip 区，优先展示 LLM 动态建议，再补充固定预设语。
*   **全屏事件遮罩**:
    * 触发全局事件时，界面中央弹出事件标题与说明的模态框，禁止后续输入。
    * 玩家通过点击「知道了，继续上班」按钮向后端发送确认请求，清空 `active_global_event`，恢复正常聊天与操作。

---

## 8. 附录：技术规范 (Appendix)

### 8.1 LLM 接入
使用内网 OpenAI 兼容接口，调用字节 Ark Doubao 模型。

```python
from openai import AsyncOpenAI
import os

API_BASE = "https://ark.cn-beijing.volces.com/api/v3"
API_KEY = os.getenv("ARK_API_KEY")

client = AsyncOpenAI(base_url=API_BASE, api_key=API_KEY)

async def call_llm(messages):
    resp = await client.chat.completions.create(
        model="doubao-seed-1-8-251228",
        messages=messages,
        temperature=0.7,
        max_tokens=512,
    )
    return resp.choices[0].message.content
```
