name: keepalive

on:
  schedule:
    - cron: "*/5 * * * *"
  workflow_dispatch: {}

jobs:
  ping:
    runs-on: ubuntu-latest
    steps:
      - name: Ping keepalive URL
        env:
          KEEPALIVE_URL: ${{ secrets.KEEPALIVE_URL }}
        run: |
          if [ -z "$KEEPALIVE_URL" ]; then
            echo "Missing KEEPALIVE_URL secret"
            exit 1
          fi
          BASE_URL="${KEEPALIVE_URL%/}"
          BASE_URL="${BASE_URL%/healthz}"
          echo "Pinging: ${BASE_URL}/healthz"
          if ! curl -fsSL --retry 3 --retry-delay 2 --max-time 25 "${BASE_URL}/healthz" > /dev/null; then
            echo "healthz failed, fallback to /"
            curl -fsSL --retry 3 --retry-delay 2 --max-time 25 "${BASE_URL}/" > /dev/null
          fi
